<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:ital,opsz,wght@0,6..12,200..1000;1,6..12,200..1000&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <title>Farkındayım - Birlik Noktası</title>
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/logo.png') }}">


<script>
    window.MEKAN_LISTESI = {{ mekanlar|tojson|safe }};
</script>

</head>

<body>
  <header>
    <nav class="navbar">
      <div class="logo">
        <img src="{{ url_for('static', filename='images/logo.png') }}">
      </div>
      <ul class="nav-links">
        <li><a href="{{ url_for('main.index') }}">Anasayfa</a></li>
        <li><a href="{{ url_for('main.hakkimizda')}}">Hakkımızda</a></li>
        <li><a href="{{ url_for('main.tum_haberler') }}">Haberler</a></li>
        <li><a href="{{ url_for('main.rotalar') }}">Rotalar</a></li>
        <li><a href="{{ url_for('main.hakkimi_biliyorum') }}">Hakkımı Biliyorum</a></li>
        <li><a href="{{url_for('main.iletisim')}}">İletişim</a></li> 
      </ul>
      <div class="gk-buton">
      
        {% if current_user.is_authenticated %}
          <div class="profil-sistemi">
            <input type="checkbox" id="profil-tetikleyici" class="profil-kontrol" hidden>

            <label for="profil-tetikleyici" class="profil-avatar-btn">
              <img src="{{ url_for('static', filename='images/pp.logo1.png') }}" alt="Profil">
            </label>

            <div class="profil-dropdown">
              <div class="profil-baslik">
                <div class="buyuk-avatar">
                    <img src="{{ url_for('static', filename='images/pp.logo1.png') }}" alt="Profil">
                </div>
                <div class="profil-bilgi">
                  <h4>{{ current_user.kullanici_adi }}</h4>
                  <span>{{ current_user.email }}</span>
                </div>
              </div>
              <hr>
              <ul class="profil-menu">
                <li><a href="{{ url_for('main.profil') }}"><i class="fa-solid fa-user"></i> Profilim</a></li>
                
                <li>
                    <a href="{{ url_for('main.bagislarim') }}" style="display: flex; justify-content: space-between; align-items: center;">
                        <span><i class="fa-solid fa-heart"></i> Bağışlarım</span>
                        <span class="bagis-etiketi">{{ cuzdan_bakiye }} ₺</span>
                    </a>
                </li>
                
                <li><a href="#"><i class="fa-solid fa-gear"></i> Ayarlar</a></li>
                <hr>
                <li>
                    <a href="{{ url_for('main.cikis_yap') }}" class="cikis-link">
                        <i class="fa-solid fa-right-from-bracket"></i> Çıkış Yap
                    </a>
                </li>
                </ul>
              <label for="profil-tetikleyici" class="profil-perde"></label>
            </div>
          </div>

        {% else %}
          
          <label for="giris-tetikleyici" class="giriş-btn">Giriş Yap</label>
          <label for="kayit-tetikleyici" class="kayıtol-btn">Kayıt Ol</label>
          
        {% endif %}

      </div>
    </nav>
  </header>

<div class="split-container">
  
  <div class="list-panel">
      <h2>{{ sehir }}</h2>
      <p class="text-muted">Engelsiz mekanlar listeleniyor.</p>
      <hr>
      
      {% if hata_mesaji %}
          <div class="alert alert-danger">{{ hata_mesaji }}</div>
      {% endif %}
      
      {% if not mekanlar and not hata_mesaji %}
          <div class="alert alert-warning">
              Maalesef, <strong>{{ sehir }}</strong> için kayıtlı engelsiz kafe veya restoran bulunamadı.
          </div>
      {% endif %}
      
      <div id="mekan-listesi">
          {% for mekan in mekanlar %}
              <div class="mekan-karti" 
                   onclick="haritayiHareketEttir('{{ mekan.lat }}', '{{ mekan.lng }}')">
                  
                  <h5 class="mb-1">{{ mekan.isim }}</h5>
                  <p class="mb-1">
                      <small class="text-muted">{{ mekan.adres }}</small>
                  </p>
                  <span class="badge bg-success">Puan: {{ mekan.puan }}</span>
                  
                  {% if mekan.maps_url %}
                    <a href="{{ mekan.maps_url }}" 
                       target="_blank" 
                       class="btn btn-sm btn-outline-primary float-end">
                       Haritada Aç
                    </a>
                  {% endif %}
              </div>
          {% endfor %}
      </div>

  </div> <div class="map-panel">
      <div id="map"></div>
  </div>

</div> <script src="https://maps.googleapis.com/maps/api/js?key={{ google_api_key }}&callback=initMap" async defer></script>

<script>
  let map; 
  
  function initMap() {
      
      const merkez = { lat: {{ merkez.lat }}, lng: {{ merkez.lng }} };
      
      map = new google.maps.Map(document.getElementById("map"), {
          zoom: 13, 
          center: merkez,
      });

      const mekanlarJS = window.MEKAN_LISTESI;
      
      const bounds = new google.maps.LatLngBounds();

      
      mekanlarJS.forEach(mekan => {
          
          if (!mekan.lat || !mekan.lng) {
              console.warn("Koordinatı eksik mekan:", mekan.isim);
              return; 
          }

          const pozisyon = { 
              lat: parseFloat(mekan.lat), 
              lng: parseFloat(mekan.lng) 
          };

          const marker = new google.maps.Marker({
              position: pozisyon,
              map: map,
              title: mekan.isim,
          });

          
          const infoWindow = new google.maps.InfoWindow({
              content: `<strong>${mekan.isim}</strong><br>${mekan.adres}<br><strong>${mekan.durum || ''}</strong>`
          });

          marker.addListener("click", () => {
              infoWindow.open(map, marker);
          });
          
          
          bounds.extend(pozisyon);
      });
      
      
      if (mekanlarJS.length > 0) {
          map.fitBounds(bounds);
      }
  }
  
  
  function haritayiHareketEttir(lat, lng) {
      const gercekLat = parseFloat(lat);
      const gercekLng = parseFloat(lng);

      if (isNaN(gercekLat) || isNaN(gercekLng)) {
          console.error("Geçersiz koordinat:", lat, lng);
          return;
      }
      
      map.panTo({ lat: gercekLat, lng: gercekLng }); 
      map.setZoom(16);
  }
</script>

</body>
</html>